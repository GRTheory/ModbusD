### Modbus通讯模式

Modbus协议是典型的master-slaver communicate结构，链路中只能有一台主设备，可以有多台从设备。主设备向从设备发送请求指令，从设备对该指令进行响应。从设备不能主动向主设备发送指令，并且从设备之间也不能进行通信。

Modbus协议通过这些请求、响应指令，实现了主设备对从设备中数字量或模拟量数据的访问和控制。通常，主设备是人机界面、监控或数据采集系统，从设备是传感器、可编程自动化控制器、智能仪器仪表等。

### Modbus数据帧格式

知道了Modbus是典型的主-从式通讯方式后，我们再来看Modbus RTU数据帧格式。

Modbus RTU数据帧由四部分组成，设备地址，功能码，数据和校验。

![](https://github.com/ForbiddenR/modbus-png/raw/main/1.png)

设备地址占1个字节，范围是0~255之间。0是广播地址，1~247是从站设备地址，248~255保留不用。

功能码占一个字节，由协议明确规定，表中列出了一些常用的功能码。譬如03功能码是读保存寄存器，16功能码是写多个寄存器。

![](https://github.com/ForbiddenR/modbus-png/raw/main/2.png)

数据部分0~252字节，其长度和内容由功能码决定。功能码不同，数据部分的定义不尽相同。

校验2个字节，由发送设备计算，将校验码之前的数据按照CRC16算法进行计算，生成2个字节的数据。放置于发送信息的尾部。接受信息的设备再重新计算接受到的信息的CRC码，比较计算得到的CRC码是否与接受到的相符，如果不相符，则表明数据在传输过程中出错。通过数据校验增加了系统的安全与效率。

常用功能码数据帧格式

1. 功能码-0x04（读输入寄存器）

   举例：读取2号站，30008~30009 2个输入寄存器的数值。

   Modbus RTU主站设备请求帧格式：

   ![](https://github.com/ForbiddenR/modbus-png/raw/main/3.png)

   2号站设备响应帧格式：

   ![](https://github.com/ForbiddenR/modbus-png/raw/main/4.png)

   

2. 功能码-0x10（写多个寄存器）

   举例：向2号站，40002~40003 2个保持寄存器分别写入0x000A，0x0102数值

   Modbus RTU主站设备请求帧格式：

   ![](https://github.com/ForbiddenR/modbus-png/raw/main/5.png)

   2号站设备响应帧格式：

   ![](https://github.com/ForbiddenR/modbus-png/raw/main/6.png)

3. 功能码-0x02（读离散量输入）

​	   举例：读取2号站， 10197~10218 22个离散量的状态。

​       Modbus RTU主站设备请求帧格式：

![](https://github.com/ForbiddenR/modbus-png/raw/main/7.png)

​     2号站设备响应帧格式：

![](https://github.com/ForbiddenR/modbus-png/raw/main/8.png)

### 数据传输模式

Modbus RTU协议数据帧是没有起始符和结束符，所以两个数据帧之间需要靠时间间隔来区分。协议中规定信息帧发送至少要有3.5个字符时间的停顿间隔。即在一个数据帧的最后一个字符传输完成之后，需要至少3.5个字符时间的停顿标定数据帧的结束，一个新的数据帧可在此停顿之后开始。如果一个新消息在小于3.5个字符时间内接着前个消息开始，接受的设备将认为它是前一数据帧的延续，这将导致CRC校验出错。同时整个数据帧必须作为一连续的流传输。如果在帧完成之前有超过1.5字符时间的停顿时间，接受设备将刷新不完整的数据帧从而认为存在丢包现象。

![](https://github.com/ForbiddenR/modbus-png/raw/main/9.png)

在Modbus-RTU通信协议中，每个数据帧包括设备地址、功能码、数据域和校验码四个部分，其中数据域中的数据是按照字节进行传输的。在每个字节的传输过程中，包含了一个起始位（Start Bit）、8个数据位（Data Bits）和一个停止位（Stop Bit），这个组合被称为一个“字符”（Character），它是数据帧中最基本的单位。

因此，一个字符实际上是指一个包含起始位、数据位和停止位的数据组合。在Modbus-RTU通信协议中，一个字符包括1个起始位、8个数据位和1个停止位，共计10位。
